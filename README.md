Резервное копирование. Васёв А.В.

## Задание 1. Резервное копирование

### Кейс

Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

В данном случае необходимо либо использовать полный бэкап, либо дифференциальный. В данном случае всё зависит от размера БД и времени через которое БД должна быть восстановлена. Если БД небольшая, то необходимо использовать полный бэкап. Если база большого объема, то лучше использовать дифференциальный, но это приведет к необходимости выделения большего объема СХД.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

В данном случае необходимо использовать инкрементальный бэкап. Но если инкрементальный бэкап необходимо выполнять каждый час, то чаще необходимо выполнять полный бэкап, для снижения риска возможности повреждения одного из файлов инкрементального быэкап и невозможности восстановления данных. Этот тип резервного копирования гораздо более экономично расходует ресурсы и место в хранилище, времени и трафика передачи данных, по сравнению с другими. Однако при восстановлении данных, в случае необходимости, из инкрементальной резервной копии происходит поэтапное восстановление с первой  до последней точки полного бэкапа включительно, и этот процесс может занять много времени в зависимости от объема данных.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Моментальное переключение на рабочую базу данных при поломке основной возможно при использовании синхронной репликации. При синхронной репликации запросы на запись будут занимать очень много времени, поскольку придется ждать ответа от каждого фоловера. Поэтому обычно используют полусинхронную или асинхронную репликацию. Компромисс между полусинхронной и асинхронной репликациями сводится к тому, насколько быстро необходимо обрабатывать запросы на запись и насколько надежными должны быть запросы на запись.

## Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

```java
pg_dump -Fc --dbname=postgresql://postgres:pa$$w0rd@192.168.0.1:5432/netology > /app/db/netology
pg_restore --dbname=postgresql://postgres:pa$$w0rd@192.168.0.1:5432/netology /app/db/netology
```

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Скрипт создания дампа можно сохранить, например, в файл dump.sh и создать задание в планировщике cron

3 0 * * * /app/db/dump.sh

Таким образом резервное копирование будет выполнять каждый день в 03:00.
Аналогично можно поступить и с восстановлением данных.

## Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

В СУБД MySQL имеются два вида бэкапов: логические и физические. Логический бэкап предполагает создание скрипта, в котором будут отражены все команды, которые необходимо выполнить для создания базы в ее текущем состоянии, со всеми актуальными данными. Физический бэкап предполагает создание резервных копий на файловом уровне. В простейшем случае, мы просто останавливаем базу и копируем файлы из рабочей папки.
На сколько удалось понять единственный способ сделать инкрементное резервное копирование в mysql без каких-либо сторонних инструментов - это использовать двоичный журнал. Т.е. сначала необходимо очистить двоичный журнал (mysqladmin -uroot -p flush-logs) и затем сохранить только вновь созданный двоичный журнал. Для просмотра созданных файлов используем ls -l /var/log/mysql/.
В данном случае на помощь могут прийти такие утилиты как, например, XtraBackup
xtrabackup --defaults-file=/etc/mysql/my.cnf --target-dir=/backup/dbdelta --incremental-basedir=/backup/db --backup

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

Как говорилось на лекции - репликация это не инструмент резервного копирования. Репликация БД подразумевает создание точной копии БД на другом физическом или виртуальном сервере. Преимущество репликации заключается в высокой доступности БД и сокращении времени простоя в сулчае выхода из строя БД, так как не нужно время на восстановление, а в случае если используется инкриментальное резервное копирование есть большая вероятность не восстановить данные вообще. репликация же в свою очередь приводит к небходимости наличия дополнительных мощностей для ее существования.
